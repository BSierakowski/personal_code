#!/usr/bin/python
<br>
import&nbsp;re,&nbsp;urllib,&nbsp;sys,&nbsp;getopt
<br>

<br>
#TODO:&nbsp;use&nbsp;asynchat&nbsp;to&nbsp;speed&nbsp;it&nbsp;up
<br>
#TODO:&nbsp;download&nbsp;the&nbsp;images?
<br>

<br>
FS_RE&nbsp;=&nbsp;re.compile('&lt;A&nbsp;HREF=\"(\S*)\"&gt;Full&nbsp;Story&lt;/A&gt;')
<br>
COM_RE&nbsp;=&nbsp;re.compile('&lt;A&nbsp;HREF=\"(\S*)\"&gt;Comments&lt;/A&gt;')
<br>

<br>
def&nbsp;regex_test(line):
<br>
&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;=&nbsp;FS_RE.search(line)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;res:&nbsp;return&nbsp;res.group(1)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:&nbsp;res&nbsp;=&nbsp;COM_RE.search(line)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;res:&nbsp;return&nbsp;res.group(1)
<br>

<br>
def&nbsp;get_diary_links(user,&nbsp;page):
<br>
&nbsp;&nbsp;&nbsp;&nbsp;p&nbsp;=&nbsp;urllib.urlopen('http://www.kuro5hin.org/user/%s/diary/%d'&nbsp;%&nbsp;(user,&nbsp;page))
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hrefs&nbsp;=&nbsp;[]
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;line&nbsp;in&nbsp;p:
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;=&nbsp;regex_test(line)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;res:&nbsp;hrefs.append(res)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hrefs
<br>

<br>
def&nbsp;save_diary(href):
<br>
&nbsp;&nbsp;&nbsp;&nbsp;params&nbsp;=&nbsp;urllib.urlencode({'commentmode':&nbsp;'nested'})
<br>
&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;urllib.urlopen('http://www.kuro5hin.org%s'&nbsp;%&nbsp;href,&nbsp;params)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;href&nbsp;=&nbsp;href.replace('/',&nbsp;'_')
<br>
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;=&nbsp;open(href[1:]&nbsp;+&nbsp;'.html',&nbsp;'w')
<br>
&nbsp;&nbsp;&nbsp;&nbsp;f.write(d.read())
<br>
&nbsp;&nbsp;&nbsp;&nbsp;f.close()
<br>

<br>
def&nbsp;get_all_diaries(user):
<br>
&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;=&nbsp;1
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hrefs&nbsp;=&nbsp;get_diary_links(user,&nbsp;count)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;h&nbsp;in&nbsp;hrefs:&nbsp;save_diary(h)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;len(hrefs)&nbsp;&gt;&nbsp;0:
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;+=&nbsp;1
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hrefs&nbsp;=&nbsp;get_diary_links(user,&nbsp;count)
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;h&nbsp;in&nbsp;hrefs:&nbsp;save_diary(h)
<br>

<br>
if&nbsp;__name__=="__main__":
<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opts,&nbsp;args&nbsp;=&nbsp;getopt.getopt(sys.argv[1:],&nbsp;'u:')
<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;getopt.GetoptError:
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;'type&nbsp;"python&nbsp;diary_ext.py&nbsp;-u&nbsp;&lt;username&gt;"&nbsp;to&nbsp;use'
<br>
&nbsp;&nbsp;&nbsp;&nbsp;username&nbsp;=&nbsp;''
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;o,&nbsp;a&nbsp;in&nbsp;opts:
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;o&nbsp;==&nbsp;"-u":&nbsp;username&nbsp;=&nbsp;a
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;username:&nbsp;print&nbsp;'type&nbsp;"python&nbsp;diary_ext.py&nbsp;-u&nbsp;&lt;username&gt;"&nbsp;to&nbsp;use'
<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:&nbsp;get_all_diaries(username)
<br>
